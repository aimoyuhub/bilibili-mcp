name: Release

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ v* æ ‡ç­¾æ—¶è§¦å‘ (å¦‚ v1.0.0)

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # éœ€è¦å†™å…¥æƒé™æ¥åˆ›å»º release
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´çš„ git å†å²ï¼Œç”¨äºç”Ÿæˆç‰ˆæœ¬å·

    - name: è®¾ç½® Go ç¯å¢ƒ
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
        cache: true

    - name: éªŒè¯ä¾èµ–
      run: |
        go mod download
        go mod verify

    - name: ä¸‹è½½ Whisper æ¨¡å‹
      run: |
        echo "ğŸ“¦ ä¸‹è½½åŸºç¡€æ¨¡å‹æ–‡ä»¶..."
        mkdir -p models
        cd models
        
        # ä¸‹è½½ base æ¨¡å‹ (~142MB)
        if [ ! -f "ggml-base.bin" ]; then
          echo "â¬‡ï¸  ä¸‹è½½ ggml-base.bin..."
          curl -L -o ggml-base.bin "https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-base.bin?download=true"
          echo "âœ… ggml-base.bin ä¸‹è½½å®Œæˆ"
        else
          echo "âœ… ggml-base.bin å·²å­˜åœ¨"
        fi
        
        # ä¸‹è½½ macOS Core ML æ¨¡å‹
        echo "ğŸš€ ä¸‹è½½ macOS Core ML åŠ é€Ÿæ¨¡å‹..."
        if [ ! -f "ggml-base.en-encoder.mlmodelc.zip" ]; then
          echo "â¬‡ï¸  ä¸‹è½½ ggml-base Core ML æ¨¡å‹..."
          curl -L -o ggml-base.en-encoder.mlmodelc.zip "https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-base.en-encoder.mlmodelc.zip?download=true"
          echo "âœ… ggml-base Core ML æ¨¡å‹ä¸‹è½½å®Œæˆ"
        fi
        
        # è§£å‹ Core ML æ¨¡å‹
        if [ -f "ggml-base.en-encoder.mlmodelc.zip" ]; then
          echo "ğŸ“‚ è§£å‹ ggml-base Core ML æ¨¡å‹..."
          unzip -q ggml-base.en-encoder.mlmodelc.zip
          rm -f ggml-base.en-encoder.mlmodelc.zip
          echo "âœ… ggml-base Core ML æ¨¡å‹è§£å‹å®Œæˆ"
        fi
        
        cd ..
        echo "ğŸ‰ æ¨¡å‹ä¸‹è½½å®Œæˆï¼"
        ls -la models/

    - name: è¿è¡Œæµ‹è¯•
      run: go test -v ./...

    - name: è·¨å¹³å°æ„å»º
      run: |
        echo "ğŸ”¨ å¼€å§‹è·¨å¹³å°æ„å»º..."
        make build-all

    - name: åˆ›å»ºåˆ†å¹³å°å‘å¸ƒåŒ…
      run: |
        echo "ğŸ“¦ åˆ›å»ºåˆ†å¹³å°å‘å¸ƒåŒ…..."
        make prepare-models
        
        # æ‰‹åŠ¨æ‰§è¡Œå‘å¸ƒæ‰“åŒ…é€»è¾‘ï¼ˆé¿å…ä¾èµ– make releaseï¼‰
        cd dist
        
        # macOS Apple Silicon - ä»…å¯æ‰§è¡Œæ–‡ä»¶
        echo "ğŸ“¦ æ‰“åŒ… macOS Apple Silicon..."
        mkdir -p darwin-arm64-package
        cp bilibili-mcp-darwin-arm64 bilibili-login-darwin-arm64 darwin-arm64-package/
        tar -czf bilibili-mcp-${GITHUB_REF#refs/tags/}-darwin-arm64.tar.gz -C darwin-arm64-package .
        rm -rf darwin-arm64-package
        
        # macOS Intel - ä»…å¯æ‰§è¡Œæ–‡ä»¶
        echo "ğŸ“¦ æ‰“åŒ… macOS Intel..."
        mkdir -p darwin-amd64-package
        cp bilibili-mcp-darwin-amd64 bilibili-login-darwin-amd64 darwin-amd64-package/
        tar -czf bilibili-mcp-${GITHUB_REF#refs/tags/}-darwin-amd64.tar.gz -C darwin-amd64-package .
        rm -rf darwin-amd64-package
        
        # Windows - ä»…å¯æ‰§è¡Œæ–‡ä»¶
        echo "ğŸ“¦ æ‰“åŒ… Windows..."
        mkdir -p windows-amd64-package
        cp bilibili-mcp-windows-amd64.exe bilibili-login-windows-amd64.exe windows-amd64-package/
        zip -r -q bilibili-mcp-${GITHUB_REF#refs/tags/}-windows-amd64.zip windows-amd64-package
        rm -rf windows-amd64-package
        
        # Linux - ä»…å¯æ‰§è¡Œæ–‡ä»¶
        echo "ğŸ“¦ æ‰“åŒ… Linux..."
        mkdir -p linux-amd64-package
        cp bilibili-mcp-linux-amd64 bilibili-login-linux-amd64 linux-amd64-package/
        tar -czf bilibili-mcp-${GITHUB_REF#refs/tags/}-linux-amd64.tar.gz -C linux-amd64-package .
        rm -rf linux-amd64-package
        
        echo "âœ… å‘å¸ƒåŒ…åˆ›å»ºå®Œæˆï¼"
        echo ""
        echo "ğŸ“‹ å‘å¸ƒåŒ…è¯´æ˜:"
        echo "   æ‰€æœ‰å¹³å°: ä»…åŒ…å«å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè½»é‡åŒ–è®¾è®¡"
        echo "   ä½¿ç”¨æ—¶ä¼šè‡ªåŠ¨ä¸‹è½½æ‰€éœ€çš„æ¨¡å‹æ–‡ä»¶"
        echo ""
        ls -la *.tar.gz *.zip

    - name: ç”Ÿæˆæ ¡éªŒå’Œæ–‡ä»¶
      run: |
        cd dist
        echo "ğŸ” ç”Ÿæˆæ ¡éªŒå’Œæ–‡ä»¶..."
        sha256sum *.tar.gz *.zip > SHA256SUMS
        echo "âœ… æ ¡éªŒå’Œæ–‡ä»¶ç”Ÿæˆå®Œæˆ"
        cat SHA256SUMS

    - name: åˆ›å»º GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          dist/*.tar.gz
          dist/*.zip
          dist/SHA256SUMS
        name: Release ${{ github.ref_name }}
        body: |
          ## ğŸ‰ bilibili-mcp ${{ github.ref_name }}
          
          ### ğŸ“¦ ä¸‹è½½è¯´æ˜
          
          **macOS ç”¨æˆ·** (æ¨è):
          - `bilibili-mcp-${{ github.ref_name }}-darwin-arm64.tar.gz` - Apple Silicon (M1/M2/M3/M4) + Core ML åŠ é€Ÿ
          - `bilibili-mcp-${{ github.ref_name }}-darwin-amd64.tar.gz` - Intel Mac + Core ML åŠ é€Ÿ
          
          **å…¶ä»–å¹³å°**:
          - `bilibili-mcp-${{ github.ref_name }}-windows-amd64.zip` - Windows x64
          - `bilibili-mcp-${{ github.ref_name }}-linux-amd64.tar.gz` - Linux x64
          
          ### âš¡ æ€§èƒ½ä¼˜åŒ–
          
          - **macOS ç‰ˆæœ¬**: åŒ…å« Core ML åŠ é€Ÿæ¨¡å‹ï¼Œè½¬å½•é€Ÿåº¦æå‡ 2-3 å€
          - **å…¶ä»–å¹³å°**: ä½¿ç”¨ä¼˜åŒ–çš„ CPU å¤šçº¿ç¨‹æ¨¡å¼
          - **æ‰€æœ‰ç‰ˆæœ¬**: é¢„è£… base æ¨¡å‹ï¼Œå¼€ç®±å³ç”¨
          
          ### ğŸš€ å¿«é€Ÿå¼€å§‹
          
          1. ä¸‹è½½å¯¹åº”å¹³å°çš„å‹ç¼©åŒ…
          2. è§£å‹åˆ°ä»»æ„ç›®å½•
          3. è¿è¡Œ `./bilibili-login` ç™»å½• Bç«™è´¦å·
          4. è¿è¡Œ `./bilibili-mcp` å¯åŠ¨æœåŠ¡
          5. åœ¨ AI å®¢æˆ·ç«¯ä¸­é…ç½® MCP åœ°å€: `http://localhost:18666/mcp`
          
          ### ğŸ” æ–‡ä»¶æ ¡éªŒ
          
          ä½¿ç”¨ SHA256SUMS æ–‡ä»¶éªŒè¯ä¸‹è½½å®Œæ•´æ€§ï¼š
          ```bash
          sha256sum -c SHA256SUMS
          ```
          
          ### ğŸ“‹ æ›´æ–°å†…å®¹
          
          è¯·æŸ¥çœ‹ [æäº¤å†å²](https://github.com/${{ github.repository }}/commits/${{ github.ref_name }}) äº†è§£è¯¦ç»†æ›´æ”¹ã€‚
        draft: false
        prerelease: false
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}