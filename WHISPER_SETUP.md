# Whisper.cpp éŸ³é¢‘è½¬å½•åŠŸèƒ½è®¾ç½®æŒ‡å—

## æ¦‚è¿°

æœ¬é¡¹ç›®ç°å·²é›†æˆ Whisper.cpp éŸ³é¢‘è½¬å½•åŠŸèƒ½ï¼Œå¯ä»¥å°†éŸ³é¢‘æ–‡ä»¶è½¬å½•ä¸ºæ–‡å­—ã€‚è¯¥åŠŸèƒ½ä½¿ç”¨æœ€å°çš„ `tiny` æ¨¡å‹ä»¥èŠ‚çœèµ„æºï¼ŒåŒæ—¶ä¿æŒè‰¯å¥½çš„è½¬å½•æ•ˆæœã€‚

## å¿«é€Ÿå¼€å§‹

### 1. ä¸‹è½½é¢„åˆ¶æ¨¡å‹ï¼ˆæ¨èï¼‰

ä¸ºäº†ç¡®ä¿ç¦»çº¿å¯ç”¨å’Œæ›´å¿«çš„åˆå§‹åŒ–ï¼Œå»ºè®®å…ˆä¸‹è½½é¢„åˆ¶æ¨¡å‹ï¼š

```bash
# åˆ›å»ºæ¨¡å‹ç›®å½•
mkdir -p models

# åŸºç¡€æ¨¡å‹ï¼ˆå¿…éœ€ï¼‰
curl -L -o models/ggml-tiny.bin "https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-tiny.bin?download=true"
curl -L -o models/ggml-base.bin "https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-base.bin?download=true"

# Core ML åŠ é€Ÿæ¨¡å‹ï¼ˆmacOS æ¨èï¼Œæ€§èƒ½æå‡ 2-3 å€ï¼‰
curl -L -o models/ggml-tiny.en-encoder.mlmodelc.zip "https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-tiny.en-encoder.mlmodelc.zip?download=true"
curl -L -o models/ggml-base.en-encoder.mlmodelc.zip "https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-base.en-encoder.mlmodelc.zip?download=true"

# è§£å‹ Core ML æ¨¡å‹
cd models
unzip -q ggml-tiny.en-encoder.mlmodelc.zip
unzip -q ggml-base.en-encoder.mlmodelc.zip
cd ..
```

### 2. åˆå§‹åŒ– Whisper.cpp

è¿è¡Œåˆå§‹åŒ–å·¥å…·æ¥è‡ªåŠ¨å®‰è£…å’Œé…ç½® Whisper.cppï¼š

```bash
./whisper-init
```

åˆå§‹åŒ–å·¥å…·ä¼šè‡ªåŠ¨ï¼š
- ğŸ–¥ï¸ **æ™ºèƒ½ç³»ç»Ÿæ£€æµ‹**ï¼šè‡ªåŠ¨è¯†åˆ«æ“ä½œç³»ç»Ÿå’ŒGPUç±»å‹
- ğŸ“¦ **é¢„åˆ¶æ¨¡å‹ä¼˜å…ˆ**ï¼šä¼˜å…ˆä½¿ç”¨å·²ä¸‹è½½çš„é¢„åˆ¶æ¨¡å‹
- âš¡ **GPUåŠ é€Ÿé…ç½®**ï¼š
  - macOS Apple Siliconï¼šå¯ç”¨ Metal åŠ é€Ÿ
  - Linux/Windowsï¼šæ£€æµ‹å¹¶å¯ç”¨ CUDA åŠ é€Ÿï¼ˆå¦‚æœ‰NVIDIA GPUï¼‰
  - å…¶ä»–æƒ…å†µï¼šä½¿ç”¨ä¼˜åŒ–çš„CPUæ¨¡å¼
- ğŸ”§ **è‡ªåŠ¨å®‰è£…ç¼–è¯‘**ï¼šå¦‚æœæœªå®‰è£…ï¼Œå¼•å¯¼å®‰è£…åˆ° `~/whisper.cpp`
- âš™ï¸ **é…ç½®æ–‡ä»¶æ›´æ–°**ï¼šè‡ªåŠ¨æ›´æ–°é…ç½®å¯ç”¨ Whisper åŠŸèƒ½

### 2. ä½¿ç”¨éŸ³é¢‘è½¬å½•åŠŸèƒ½

åˆå§‹åŒ–å®Œæˆåï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ `whisper_audio_2_text` MCP å·¥å…·ï¼š

```json
{
  "name": "whisper_audio_2_text",
  "arguments": {
    "audio_path": "/path/to/your/audio.mp3",
    "language": "zh",
    "model": "tiny"
  }
}
```

## æ”¯æŒçš„åŠŸèƒ½

### éŸ³é¢‘æ ¼å¼æ”¯æŒ
- **è¾“å…¥æ ¼å¼**ï¼šMP3, WAV, M4A, FLAC ç­‰å¸¸è§æ ¼å¼
- **è‡ªåŠ¨è½¬æ¢**ï¼šè‡ªåŠ¨è½¬æ¢ä¸º Whisper éœ€è¦çš„ 16kHz å•å£°é“ WAV æ ¼å¼

### è¯­è¨€æ”¯æŒ
- `zh` - ä¸­æ–‡ï¼ˆé»˜è®¤ï¼‰
- `en` - è‹±æ–‡
- `ja` - æ—¥è¯­
- `auto` - è‡ªåŠ¨æ£€æµ‹

### æ¨¡å‹é€‰æ‹©
| æ¨¡å‹å | å¤§å° | é€Ÿåº¦ | å‡†ç¡®æ€§ | æ¨èåœºæ™¯ |
|--------|------|------|--------|----------|
| `tiny` | 39MB | æœ€å¿« | åŸºç¡€ | **é»˜è®¤é€‰æ‹©**ï¼Œå¿«é€Ÿè½¬å½• |
| `base` | 142MB| å¿« | è‰¯å¥½ | å¹³è¡¡é€Ÿåº¦å’Œè´¨é‡ |
| `small` | 466MB| è¾ƒå¿« | å¾ˆå¥½ | é«˜è´¨é‡éœ€æ±‚ |
| `medium` | 1.5GB| æ…¢ | ä¼˜ç§€ | ä¸“ä¸šè½¬å½• |
| `large` | 2.9GB| å¾ˆæ…¢ | æœ€ä½³ | æœ€é«˜è´¨é‡ |

## é…ç½®é€‰é¡¹

é…ç½®æ–‡ä»¶ `config.yaml` ä¸­çš„ Whisper ç›¸å…³è®¾ç½®ï¼š

```yaml
features:
  whisper:
    enabled: true  # å¯ç”¨ Whisper åŠŸèƒ½
    whisper_cpp_path: "/Users/yourname/whisper.cpp"  # Whisper.cpp å®‰è£…è·¯å¾„
    model_path: "/Users/yourname/whisper.cpp/models/ggml-tiny.bin"  # æ¨¡å‹æ–‡ä»¶è·¯å¾„
    default_model: "tiny"  # é»˜è®¤ä½¿ç”¨çš„æ¨¡å‹
    language: "zh"  # é»˜è®¤è¯†åˆ«è¯­è¨€
    cpu_threads: 4  # CPU çº¿ç¨‹æ•°
    timeout_seconds: 600  # è½¬æ¢è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
    enable_gpu: true  # å¯ç”¨GPUåŠ é€Ÿ
    enable_core_ml: true  # å¯ç”¨Core MLåŠ é€Ÿï¼ˆmacOSï¼‰
```

## æ€§èƒ½ä¼˜åŒ–

### macOS
- **Apple Silicon (M1/M2/M3/M4)**ï¼š
  - è‡ªåŠ¨å¯ç”¨ **Metal GPU åŠ é€Ÿ**
  - æ”¯æŒ **Core ML** ä¼˜åŒ–æ¨¡å‹
  - å»ºè®®ä½¿ç”¨ `tiny` æˆ– `base` æ¨¡å‹ä»¥è·å¾—æœ€ä½³æ€§èƒ½
- **Intel Mac**ï¼š
  - ä½¿ç”¨ä¼˜åŒ–çš„ CPU å¤šçº¿ç¨‹å¤„ç†
  - å¯è°ƒæ•´ `cpu_threads` å‚æ•°ä¼˜åŒ–æ€§èƒ½

### Linux
- **NVIDIA GPU**ï¼šè‡ªåŠ¨æ£€æµ‹å¹¶å¯ç”¨ CUDA åŠ é€Ÿ
- **CPUæ¨¡å¼**ï¼šä½¿ç”¨å¤šçº¿ç¨‹ä¼˜åŒ–
- å»ºè®®æ ¹æ® CPU æ ¸å¿ƒæ•°è®¾ç½® `cpu_threads`

### Windows  
- **NVIDIA GPU**ï¼šè‡ªåŠ¨æ£€æµ‹å¹¶å¯ç”¨ CUDA åŠ é€Ÿ
- **CPUæ¨¡å¼**ï¼šä½¿ç”¨å¤šçº¿ç¨‹ä¼˜åŒ–
- éœ€è¦å®‰è£… Visual Studio Build Tools è¿›è¡Œç¼–è¯‘

### å†…å­˜ä½¿ç”¨
- `tiny` æ¨¡å‹ï¼šçº¦ 100MB å†…å­˜
- `base` æ¨¡å‹ï¼šçº¦ 200MB å†…å­˜
- `small` æ¨¡å‹ï¼šçº¦ 500MB å†…å­˜

### è¶…æ—¶è®¾ç½®
- **é»˜è®¤è¶…æ—¶**ï¼š20åˆ†é’Ÿï¼ˆ1200ç§’ï¼‰
- **å¤§æ–‡ä»¶å»ºè®®**ï¼šå¯åœ¨é…ç½®æ–‡ä»¶ä¸­è°ƒæ•´ `timeout_seconds`
- **å»ºè®®å€¼**ï¼š
  - å°æ–‡ä»¶ï¼ˆ<10åˆ†é’Ÿï¼‰ï¼š600ç§’
  - ä¸­ç­‰æ–‡ä»¶ï¼ˆ10-30åˆ†é’Ÿï¼‰ï¼š1200ç§’
  - å¤§æ–‡ä»¶ï¼ˆ>30åˆ†é’Ÿï¼‰ï¼š1800ç§’æˆ–æ›´é•¿

## æ•…éšœæ’é™¤

### 1. åˆå§‹åŒ–å¤±è´¥

**é—®é¢˜**ï¼šè¿è¡Œ `./bilibili-whisper-init` æ—¶å‡ºé”™

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ç¡®ä¿å·²å®‰è£… `git`ã€`cmake`ã€`make`
- macOS ç”¨æˆ·éœ€è¦å®‰è£… Xcode Command Line Toolsï¼š
  ```bash
  xcode-select --install
  ```
- ç¡®ä¿æœ‰è¶³å¤Ÿçš„ç£ç›˜ç©ºé—´ï¼ˆè‡³å°‘ 1GBï¼‰

### 2. ç¼–è¯‘å¤±è´¥

**é—®é¢˜**ï¼šWhisper.cpp ç¼–è¯‘å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥æ˜¯å¦å®‰è£…äº†å®Œæ•´çš„å¼€å‘å·¥å…·é“¾
- å°è¯•æ‰‹åŠ¨ç¼–è¯‘ï¼š
  ```bash
  cd ~/whisper.cpp
  mkdir build && cd build
  cmake -DCMAKE_BUILD_TYPE=Release ..
  make -j$(nproc)
  ```

### 3. æ¨¡å‹ä¸‹è½½å¤±è´¥

**é—®é¢˜**ï¼šæ¨¡å‹æ–‡ä»¶ä¸‹è½½å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥ç½‘ç»œè¿æ¥
- æ‰‹åŠ¨ä¸‹è½½æ¨¡å‹ï¼š
  ```bash
  cd ~/whisper.cpp/models
  bash download-ggml-model.sh tiny
  ```

### 4. è½¬å½•å¤±è´¥

**é—®é¢˜**ï¼šéŸ³é¢‘è½¬å½•æ—¶å‡ºé”™

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥éŸ³é¢‘æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”å¯è¯»
- ç¡®ä¿å®‰è£…äº† `ffmpeg`ï¼š
  ```bash
  # macOS
  brew install ffmpeg
  
  # Ubuntu/Debian
  sudo apt install ffmpeg
  ```
- æ£€æŸ¥é…ç½®æ–‡ä»¶ä¸­çš„è·¯å¾„æ˜¯å¦æ­£ç¡®

### 5. Core ML é”™è¯¯

**é—®é¢˜**ï¼šmacOS ä¸Šå‡ºç° Core ML ç›¸å…³é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
- åœ¨é…ç½®æ–‡ä»¶ä¸­ç¦ç”¨ Core MLï¼š
  ```yaml
  features:
    whisper:
      enable_core_ml: false
  ```
- æˆ–è€…é‡æ–°ä¸‹è½½ Core ML æ¨¡å‹

## ä½¿ç”¨ç¤ºä¾‹

### åŸºç¡€ä½¿ç”¨

```json
{
  "name": "whisper_audio_2_text",
  "arguments": {
    "audio_path": "./downloads/audio.mp3"
  }
}
```

### æŒ‡å®šè¯­è¨€å’Œæ¨¡å‹

```json
{
  "name": "whisper_audio_2_text",
  "arguments": {
    "audio_path": "./downloads/english_audio.wav",
    "language": "en",
    "model": "base"
  }
}
```

### è½¬å½•ç»“æœ

è½¬å½•å®Œæˆåä¼šè¿”å›ï¼š
- **è½¬å½•æ–‡æœ¬**ï¼šæå–çš„çº¯æ–‡æœ¬å†…å®¹
- **SRTæ–‡ä»¶**ï¼šåŒ…å«æ—¶é—´è½´çš„å­—å¹•æ–‡ä»¶ï¼ˆå®Œæ•´ç»å¯¹è·¯å¾„ï¼‰
- **å¤„ç†ä¿¡æ¯**ï¼šä½¿ç”¨çš„æ¨¡å‹ã€è¯­è¨€ã€åŠ é€Ÿç±»å‹ã€å¤„ç†æ—¶é—´ç­‰
- **åŠ é€Ÿä¿¡æ¯**ï¼šè¯¦ç»†æ˜¾ç¤ºä½¿ç”¨çš„åŠ é€Ÿç±»å‹ï¼ˆCore MLã€Metalã€CUDAæˆ–CPUï¼‰
- **å¯ç”¨æ¨¡å‹åˆ—è¡¨**ï¼šæ˜¾ç¤ºå½“å‰ç³»ç»Ÿä¸­æ‰€æœ‰å¯ç”¨çš„æ¨¡å‹åŠå…¶è¯¦ç»†ä¿¡æ¯

#### å¯ç”¨æ¨¡å‹æ˜¾ç¤ºæ ¼å¼

```
ğŸ“š å½“å‰å¯ç”¨æ¨¡å‹
 âœ… tiny - æœ€å¿«é€Ÿåº¦ï¼ŒåŸºç¡€å‡†ç¡®æ€§ (~39MB) + Core MLåŠ é€Ÿ ğŸš€ [74.1MB]
    base - å¹³è¡¡é€Ÿåº¦å’Œè´¨é‡ (~142MB) + Core MLåŠ é€Ÿ ğŸš€ [141.1MB]
```

- **âœ…** æ ‡è®°å½“å‰ä½¿ç”¨çš„æ¨¡å‹
- **ğŸš€** è¡¨ç¤ºæ”¯æŒCore MLåŠ é€Ÿ
- **[æ–‡ä»¶å¤§å°]** æ˜¾ç¤ºå®é™…æ–‡ä»¶å¤§å°

### æ™ºèƒ½åŠ é€Ÿæ£€æµ‹

ç³»ç»Ÿä¼šè‡ªåŠ¨æ£€æµ‹å¹¶é€‰æ‹©æœ€ä¼˜çš„åŠ é€Ÿæ–¹å¼ï¼š

1. **macOS + é¢„åˆ¶Core MLæ¨¡å‹** â†’ ä½¿ç”¨ Core ML åŠ é€Ÿï¼ˆæœ€å¿«ï¼‰
2. **macOS Apple Silicon** â†’ ä½¿ç”¨ Metal GPU åŠ é€Ÿ
3. **Linux/Windows + NVIDIA GPU** â†’ ä½¿ç”¨ CUDA åŠ é€Ÿ
4. **å…¶ä»–æƒ…å†µ** â†’ ä½¿ç”¨ä¼˜åŒ–çš„CPUå¤šçº¿ç¨‹æ¨¡å¼

### æ™ºèƒ½æ¨¡å‹é€‰æ‹©

ç³»ç»Ÿç°åœ¨æ”¯æŒæ™ºèƒ½æ¨¡å‹é€‰æ‹©ï¼Œ**å»ºè®®ä¸ä¼ é€’modelå‚æ•°**ï¼Œè®©ç³»ç»Ÿè‡ªåŠ¨é€‰æ‹©æœ€ä½³å¯ç”¨æ¨¡å‹ï¼š

#### æ¨èä½¿ç”¨æ–¹å¼ï¼ˆæ— éœ€æŒ‡å®šæ¨¡å‹ï¼‰

```json
{
  "tool": "whisper_audio_2_text", 
  "arguments": {
    "audio_path": "/path/to/audio.mp3"
    // ä¸ä¼ modelå‚æ•°ï¼Œç³»ç»Ÿè‡ªåŠ¨é€‰æ‹©æœ€ä½³æ¨¡å‹
  }
}
```

#### é…ç½®è¯´æ˜

```yaml
features:
  whisper:
    default_model: "auto"  # æ¨èè®¾ç½®ï¼Œæ™ºèƒ½é€‰æ‹©æœ€ä½³æ¨¡å‹
```

#### æ™ºèƒ½é€‰æ‹©ç­–ç•¥

1. **ä¼˜é€‰é¡ºåº**ï¼š`base` â†’ `small` â†’ `medium` â†’ `large` â†’ `tiny`
2. **è‡ªåŠ¨æ¨¡å¼**ï¼šä¸ä¼ modelå‚æ•°æˆ–ä½¿ç”¨ `"model": "auto"`
3. **æ‰‹åŠ¨æŒ‡å®š**ï¼šæ˜ç¡®æŒ‡å®šæ¨¡å‹æ—¶ä¼˜å…ˆä½¿ç”¨ï¼Œä¸å­˜åœ¨æ—¶è‡ªåŠ¨é™çº§
4. **æ—¥å¿—æç¤º**ï¼šæ˜¾ç¤ºå®é™…ä½¿ç”¨çš„æ¨¡å‹å’Œé€‰æ‹©åŸå› 

**æ™ºèƒ½é€‰æ‹©ç¤ºä¾‹**ï¼š
```
ğŸ¯ æ™ºèƒ½é€‰æ‹©æœ€ä½³å¯ç”¨æ¨¡å‹...
ğŸ” æŒ‰ä¼˜å…ˆçº§æœç´¢æœ€ä½³æ¨¡å‹: [base small medium large tiny]
âœ… è‡ªåŠ¨é€‰æ‹©æœ€ä½³å¯ç”¨æ¨¡å‹: base
```

**æ‰‹åŠ¨æŒ‡å®šç¤ºä¾‹**ï¼ˆå¯é€‰ï¼‰ï¼š
```json
{
  "tool": "whisper_audio_2_text",
  "arguments": {
    "audio_path": "/path/to/audio.mp3",
    "model": "base"  // æ˜ç¡®æŒ‡å®šä½¿ç”¨baseæ¨¡å‹
  }
}
```

### è½¬å½•æ—¥å¿—

è½¬å½•è¿‡ç¨‹ä¸­ä¼šæ˜¾ç¤ºè¯¦ç»†æ—¥å¿—ï¼š
```
ğŸ¯ æ£€æµ‹åˆ°åŠ é€Ÿç±»å‹: Core ML
ğŸš€ å¯ç”¨ Core ML åŠ é€Ÿ (Apple Neural Engine)
ğŸ”§ æ‰§è¡Œwhisperå‘½ä»¤: /path/to/whisper-cli -f audio.wav -m model.bin -osrt -l zh -of output
â±ï¸ è®¾ç½®è¶…æ—¶æ—¶é—´: 1200ç§’ (20.0åˆ†é’Ÿ)
ğŸ” æ£€æµ‹åˆ°å®é™…ä½¿ç”¨: Core ML åŠ é€Ÿ
ğŸ“Š å¤„ç†è¿›åº¦: [========>  ] 80%
â±ï¸ æ€§èƒ½ä¿¡æ¯: processing time: 15.2s, real time factor: 0.25
âœ… Whisper è½¬å½•æ‰§è¡ŒæˆåŠŸ
ğŸ“„ è½¬å½•å®Œæˆï¼Œæå–æ–‡æœ¬é•¿åº¦: 1024 å­—ç¬¦
```

## æ³¨æ„äº‹é¡¹

1. **é¦–æ¬¡ä½¿ç”¨**ï¼šç¬¬ä¸€æ¬¡è½¬å½•ä¼šæ¯”è¾ƒæ…¢ï¼Œå› ä¸ºéœ€è¦åŠ è½½æ¨¡å‹
2. **æ–‡ä»¶å¤§å°**ï¼šå»ºè®®éŸ³é¢‘æ–‡ä»¶ä¸è¶…è¿‡ 100MBï¼Œè¿‡å¤§çš„æ–‡ä»¶å¯èƒ½å¯¼è‡´è¶…æ—¶
3. **ç½‘ç»œéœ€æ±‚**ï¼šä»…åœ¨ä¸‹è½½æ¨¡å‹æ—¶éœ€è¦ç½‘ç»œè¿æ¥ï¼Œè½¬å½•è¿‡ç¨‹å®Œå…¨ç¦»çº¿
4. **éšç§ä¿æŠ¤**ï¼šæ‰€æœ‰è½¬å½•éƒ½åœ¨æœ¬åœ°å®Œæˆï¼Œä¸ä¼šä¸Šä¼ åˆ°ä»»ä½•æœåŠ¡å™¨

## æ›´æ–°å’Œç»´æŠ¤

### æ›´æ–° Whisper.cpp

```bash
cd ~/whisper.cpp
git pull
cd build
make clean
make -j$(nproc)
```

### ä¸‹è½½æ–°æ¨¡å‹

```bash
cd ~/whisper.cpp/models
bash download-ggml-model.sh [model_name]
```

### æ¸…ç†ç©ºé—´

```bash
# åˆ é™¤ä¸éœ€è¦çš„æ¨¡å‹æ–‡ä»¶
rm ~/whisper.cpp/models/ggml-*.bin

# ä¿ç•™ tiny æ¨¡å‹
cd ~/whisper.cpp/models
bash download-ggml-model.sh tiny
```

---

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶ `logs/bilibili-mcp.log` è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚
